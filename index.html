<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Changing Square Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
</head>
<body>
    <script>
        const GAME_PEER_CODE = 'ChummyGamesColorGame';

        // ========================================
        // GLOBAL VARIABLES
        // ========================================

        // +++ Game Views +++
        // ++++++++++++++++++
        const VIEWS = {
            
            // Login Views
            LOGIN: 'login',
            AFTER_LOGIN_WAIT: 'afterLoginWait',

            // Host Views
            HOST_GAME_MAIN: 'hostGameMain',

            // Player Views
            GAME_MAIN: 'gameMain',
            GAME_CHOOSE_COLOR: 'gameChooseColor'
        };
        
        // +++ User Meta Data +++
        // ++++++++++++++++++++++
        let peer = null;
        let connections = [];
        let isHost = false;
        let currentView = VIEWS.LOGIN;
        let playerId = Array.from({ length: 7 }, () => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[Math.floor(Math.random() * 26)]).join('');
        let playerName = '';

        // +++ Game Data +++
        // +++++++++++++++++
        let gameData = {
            
            // Game Meta Data
            playerList: [],
            gameStarted: false,
            hostInfo: {},

            // Game Data
            squareColor: 'blue',
            currentTurnPlayerName: null
        };

        // +++ User Player Defualt data +++
        // ++++++++++++++++++++++++++++++++
        let defualtPlayerInfo = {

            // User Meta Data
            peerId: null,
            id: null,
            name: null,
            isHost: false,
            isVIP: false,
            connectedStatus: 'Connected',
            stillHere: true,

            // Player Game Data
            color: 'black',
            turnOrder: -1
        }

        // +++ Game starter data +++
        // +++++++++++++++++++++++++
        let playerAvalableColors = ['green','pink','red','blue','brown','orange','gray'];

        // ========================================
        // LOGIN FUNCTIONS
        // ========================================
        
        function createView_Login() {
            clearBody();
            currentView = VIEWS.LOGIN;
            
            const container = document.createElement('div');
            Object.assign(container.style, {
                textAlign: 'center',
                padding: '20px',
                backgroundColor: 'white',
                borderRadius: '10px',
                boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
                minWidth: '300px'
            });
            
            // Title
            const title = document.createElement('h1');
            title.textContent = 'Color Square Game - by ChummyGames - v0.2';
            Object.assign(title.style, {
                color: '#333',
                marginBottom: '20px'
            });
            
            // Name input
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = 'Enter your name';
            nameInput.id = 'nameInput';
            
            Object.assign(nameInput.style, {
                width: '200px',
                padding: '10px',
                marginBottom: '20px',
                border: '1px solid #ccc',
                borderRadius: '5px',
                fontSize: '14px'
            });
            
            const hostButton = createButton('Host Game', '#28a745', handleHostClick);
            const joinButton = createButton('Join Game', '#007bff', handleJoinClick);
            
            container.appendChild(title);
            container.appendChild(hostButton);
            container.appendChild(nameInput);
            container.appendChild(joinButton);
            document.body.appendChild(container);
        }
               
        function createView_ConnectionStatus(message, type = 'info') {
            const statusDivOld = document.getElementById('statusDiv');
            if(statusDivOld){
                document.body.removeChild(statusDivOld);
            }

            const statusDiv = document.createElement('div');
            statusDiv.id = 'statusDiv';
            statusDiv.textContent = 'Choose to host or join';
            
            Object.assign(statusDiv.style, {
                position: 'fixed',
                top: '20px',
                left: '50%',
                transform: 'translateX(-50%)',
                padding: '10px 20px',
                backgroundColor: '#fff',
                border: '1px solid #ccc',
                borderRadius: '5px',
                zIndex: '1000',
                fontSize: '14px'
            });
            
            statusDiv.textContent = message;
            
            const colors = {
                info: { bg: '#d1ecf1', border: '#bee5eb' },
                success: { bg: '#d4edda', border: '#c3e6cb' },
                error: { bg: '#f8d7da', border: '#f5c6cb' },
                warning: { bg: '#fff3cd', border: '#ffeaa7' }
            };
            
            const color = colors[type] || colors.info;
            Object.assign(statusDiv.style, {
                backgroundColor: color.bg,
                borderColor: color.border
            });

            document.body.appendChild(statusDiv);

            // Fades out the statusDiv over 1 second (1000ms)
            fadeOut(statusDiv, 3000)
        } 

        function handleHostClick() {
            isHost = true;
            createView_ConnectionStatus('Initializing host connection...', 'info');
            
            peer = new Peer(GAME_PEER_CODE);
            
            peer.on('open', (id) => {
                createView_ConnectionStatus(`Hosting as: ${id} (waiting for players...)`, 'success');

                // --------------------------- TODO ---------------------------------------------------------------------------------------------
                let hostinfo = JSON.parse(JSON.stringify(defualtPlayerInfo));
                hostinfo.peerId = id;
                hostinfo.id = playerId;
                hostinfo.name = 'HOST';
                hostinfo.isHost = true;
                gameData.hostInfo = hostinfo;
                // suffle avalable colors
                playerAvalableColors = shuffleList(playerAvalableColors)
                createView_AfterLoginWait(true);
                createView_PlayerStatus();

                

                if(isHost){
                    setInterval(() => {
                        console.log("HELLO1")
                        gameData.playerList.forEach(player => {
                            player.stillHere = false
                        });
                        sendMessage('YallStillHere')
                        const hello = setInterval(() => {
                            console.log("HELLO2")
                            
                            
                            gameData.playerList.forEach(player => {
                                if(!player.stillHere){
                                    console.log(player.name+' is missing')
                                    connections.find(conn => conn.peer === player.peerId).close();
                                }
                            });

                            clearInterval(hello);
                        }, 10000); // 15 seconds
                    }, 20000); // 15 seconds
                }
            });
            
            peer.on('connection', function (connection) {
                connections.push(connection);
                createView_ConnectionStatus(`Hosting (${connections.length} player(s) connected)`, 'success');
                
                connection.on('data', receiveMessage);
                connection.on('close', () => {
                    connections = connections.filter(c => c !== connection);
                    createView_ConnectionStatus(`Hosting (${connections.length} player(s) connected)`, 'success');

                    // --------------------------- TODO ---------------------------------------------------------------------------------------------
                    // Set player in list as disconnected
                    gameData.playerList.forEach(player => {
                        if(!connections.some(conn => conn.peer === player.peerId)){
                            player.connectedStatus = 'Disconnected'
                        }
                    });
                    createView_AfterLoginWait(false);
                    // Refresh player status
                    updateView_PlayerStatus();
                    // Refresh player status on player screens
                    sendMessage('updatePlayerStatus');
                });
                connection.on('disconnected', () => {
                    connections = connections.filter(c => c !== connection);
                    createView_ConnectionStatus(`Hosting (${connections.length} player(s) connected)`, 'success');

                    // --------------------------- TODO ---------------------------------------------------------------------------------------------
                    // Set player in list as disconnected
                    gameData.playerList.forEach(player => {
                        if(!connections.some(conn => conn.peer === player.peerId)){
                            player.connectedStatus = 'Disconnected'
                        }
                    });
                    createView_AfterLoginWait(false);
                    // Refresh player status
                    updateView_PlayerStatus();
                    // Refresh player status on player screens
                    sendMessage('updatePlayerStatus');
                });
            });
            peer.on('error', (err) => {
                createView_ConnectionStatus(`Error: ${err.message}`, 'error');
            });
        }
        
        function handleJoinClick() {
            const nameInput = document.getElementById('nameInput');
            playerName = nameInput.value.trim();
            
            if (!playerName) {
                alert('Please enter your name first!');
                return;
            }
            
            isHost = false;
            createView_ConnectionStatus('Connecting to host...', 'info');
            
            peer = new Peer();
            
            peer.on('open', (id) => {
                const connection = peer.connect(GAME_PEER_CODE);
                
                connection.on('open', () => {
                    connections.push(connection);
                    createView_ConnectionStatus(`Connected as: ${id}`, 'success');
                    sendMessage('playerJoined', {
                        peerId: id,
                        playerId: playerId,
                        playerName: playerName
                    });
                });
                
                connection.on('data', receiveMessage);
                connection.on('close', () => {
                    connections = connections.filter(c => c !== connection);
                    createView_ConnectionStatus('Connection lost. Try reconnecting...', 'warning');
                });
                
                connection.on('disconnected', () => {
                    connections = connections.filter(c => c !== connection);
                    createView_ConnectionStatus('Connection lost. Try reconnecting...', 'warning');
                });
                connection.on('error', (err) => {
                    createView_ConnectionStatus(`Connection failed: ${err.message}`, 'error');
                });
            });
            
            peer.on('error', (err) => {
                createView_ConnectionStatus(`Error: ${err.message}`, 'error');
            });
        }
        
        function handleLoginHostMessage(message) {
            switch (message.type) {
                case 'updatePlayerStatus':
                    updateView_PlayerStatus();
                    break;
                
                case 'moveToWaitRoom':
                    // If new Player show wait view and player statuses
                    if (message.data.targetPlayerId === playerId) {
                        if(gameData.gameStarted){
                            createView_GameMain(true);
                        }
                        else{
                            createView_AfterLoginWait(true);
                        }
                        createView_TogglePlayerStatusView();
                    }
                    // If not new Player refresh player statuses
                    else{
                        if(!gameData.gameStarted){
                            createView_AfterLoginWait(true);
                        }
                        updateView_PlayerStatus();
                    }
                    break;

                case 'gameStarted':
                    // Move to game view when VIP starts the game
                    createView_GameMain(true);
                    break;

                case 'nameInUse':
                    if (message.data.targetPlayerId === playerId) {
                        alert('Name already in use! Please choose a different name.');
                        createView_Login();
                    }
                    break;

                case 'gameAlreadyStarted':
                    if (message.data.targetPlayerId === playerId) {
                        alert('Game has already started! You cannot join now.');
                        createView_Login();
                    }
                    break;
                case 'YallStillHere':
                    sendMessage('IAmHere')
                    break;
            }
        }
        
        function handleLoginGuestMessage(message) {
            switch (message.type) {
                case 'IAmHere':
                    gameData.playerList.filter(p => p.id == message.playerId)[0].stillHere = true;
                    break;
                case 'playerJoined':
                    const { peerId:newPeerId, playerId:newPlayerId, playerName:newPlayerName } = message.data;
                    
                    // (HOST LOGIN ACTION) Check if name is already in use by a connected user
                    if (gameData.playerList.some(p => p.name === newPlayerName && p.connectedStatus === 'Connected')) {
                        sendMessage('nameInUse', { targetPlayerId: newPlayerId });
                        // Disconnect the player
                        setTimeout(() => {
                        const connectionToRemove = connections.find(conn => conn.peer === newPeerId);
                            if (connectionToRemove) {
                                connectionToRemove.close();
                            }
                        }, 1000); // 1000 milliseconds = 1 second
                        return;
                    }
                    
                    // (HOST LOGIN ACTION) Update disconnected existing player
                    // Check if new connection is a disconnected player
                    const disconnectedExistingPlayerIndex = gameData.playerList.findIndex(p => p.name === newPlayerName && p.connectedStatus === 'Disconnected');
                    if (disconnectedExistingPlayerIndex >= 0) {
                        existPlayer = gameData.playerList[disconnectedExistingPlayerIndex]
                        existPlayer.peerId = newPeerId,
                        existPlayer.id = newPlayerId,
                        existPlayer.connectedStatus = 'Connected'
                    } else {                    
                        // (HOST LOGIN ACTION) New Player BUT game has already started
                        if (gameData.gameStarted) {
                            sendMessage('gameAlreadyStarted', { targetPlayerId: newPlayerId });
                            // Disconnect the player
                            setTimeout(() => {
                            const connectionToRemove = connections.find(conn => conn.peer === newPeerId);
                                if (connectionToRemove) {
                                    connectionToRemove.close();
                                }
                            }, 1000); // 1000 milliseconds = 1 second
                            return;
                        }
                        
                        // (HOST LOGIN ACTION) Add new player - first non-host player becomes VIP
                        let newplayerinfo = JSON.parse(JSON.stringify(defualtPlayerInfo));
                        newplayerinfo.peerId = newPeerId;
                        newplayerinfo.id = newPlayerId;
                        newplayerinfo.name = newPlayerName;
                        newplayerinfo.isVIP = gameData.playerList.length === 0;
                        newplayerinfo.color = playerAvalableColors[gameData.playerList.length]
                        gameData.playerList.push(newplayerinfo);
                    }
                    
                    updateView_PlayerStatus();
                    sendMessage('moveToWaitRoom', { targetPlayerId: newPlayerId });
                    break;

                case 'startGame':
                    // Only VIP can start the game
                    const playerIsVIP = gameData.playerList.find(p => p.isVIP && p.id === message.playerId);
                    if (playerIsVIP) {
                        // Game started
                        gameData.gameStarted = true;
                        // Set player turn order
                        let turnOrderNumbers = [];
                        gameData.playerList.forEach(element => {turnOrderNumbers.push(turnOrderNumbers.length)});
                        turnOrderNumbers = shuffleList(turnOrderNumbers);
                        let count = 0;
                        gameData.playerList.forEach(playerInfo => {
                            turnNumber = turnOrderNumbers[count];
                            count += 1

                            if(turnNumber == 0){
                                gameData.currentTurnPlayerName = playerInfo.name;
                            }
                            playerInfo.turnOrder = turnNumber;
                        });
                        createView_HostGameMain(true);
                        sendMessage('gameStarted');
                    }
                    break;
            }
        }

        // ========================================
        // PLAYER STATUS VIEW FUNCTIONS
        // ========================================
        
        function createView_TogglePlayerStatusView(){
            // Remove existing playerStatusDiv if it exists
            const existingDiv = document.getElementById('togglePlayerStatusDiv');
            if (existingDiv) {
                document.body.removeChild(existingDiv);
            }

            const togglePlayerStatusDiv = document.createElement('div');
            togglePlayerStatusDiv.id = 'togglePlayerStatusDiv';
            
            Object.assign(togglePlayerStatusDiv.style, {
                position: 'fixed',
                top: '20px',
                left: '20px',
                //transform: 'translateY(-50%)',
                padding: '15px 20px',
                backgroundColor: 'rgba(255, 255, 255, 0.3)',
                border: '2px solid #ddd',
                borderRadius: '10px',
                //boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
                zIndex: '1000',
                fontSize: '13px',
            });

            togglePlayerStatusDiv.addEventListener('click', function (){
                document.body.removeChild(this);
                createView_PlayerStatus();
            })

            togglePlayerStatusDiv.textContent = "👤 >";
            document.body.appendChild(togglePlayerStatusDiv);
        }
        
        function createView_PlayerStatus() {
            // Remove existing playerStatusDiv if it exists
            const existingDiv = document.getElementById('playerStatusDiv');
            if (existingDiv) {
                document.body.removeChild(existingDiv);
            }

            const playerStatusDiv = document.createElement('div');
            playerStatusDiv.id = 'playerStatusDiv';
            
            Object.assign(playerStatusDiv.style, {
                position: 'fixed',
                top: '20px',
                left: '20px',
                //transform: 'translateY(-50%)',
                padding: '15px 20px',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                border: '2px solid #ddd',
                borderRadius: '10px',
                boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
                zIndex: '1000',
                fontSize: '13px',
                maxWidth: '400px',
                minWidth: '300px'
            });

            playerStatusDiv.addEventListener('click', function (){
                document.body.removeChild(this);
                createView_TogglePlayerStatusView();
            })

            document.body.appendChild(playerStatusDiv);
            updateView_PlayerStatus();
        }

        function updateView_PlayerStatus() {
            const playerStatusDiv = document.getElementById('playerStatusDiv');
            if(playerStatusDiv){
                let statusText = '';
                
                // Current player info
                if (isHost) {
                    statusText += '🏠 HOST SCREEN\n';
                } else {
                    statusText += `👤 Player: ${playerName}\n`;
                }
                
                statusText += '\nPlayers List:\n';
                
                // Show all players with their status
                gameData.playerList.forEach(player => {
                    if(!player.isHost){
                        let playerLine = '';
                        
                        if (player.isHost) {
                            playerLine += '🏠 HOST';
                        } else {
                            playerLine += `• ${player.name}`;
                            if (player.isVIP) {
                                playerLine += ' (🌟VIP)';
                            }
                        }
                        
                        // Add connection status with emojis
                        if (player.connectedStatus === 'Connected') {
                            playerLine += ' 🟢';
                        } else {
                            playerLine += ' 🔴';
                        }
                        
                        statusText += playerLine + '\n';
                    }
                });
                
                playerStatusDiv.textContent = statusText;
                playerStatusDiv.style.whiteSpace = 'pre-line';
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        
        function shuffleList(lst) {
            for (let i = lst.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [lst[i], lst[j]] = [lst[j], lst[i]];
            }
            for (let i = lst.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [lst[i], lst[j]] = [lst[j], lst[i]];
            }
            return lst
        }

        function clearBody() {
            const statusDiv = document.getElementById('statusDiv');
            const playerStatusDiv = document.getElementById('playerStatusDiv');
            const children = Array.from(document.body.children);
            
            children.forEach(child => {
                if (child !== statusDiv && child !== playerStatusDiv) {
                    document.body.removeChild(child);
                }
            });
        }
        
        function applyBodyStyles() {
            Object.assign(document.body.style, {
                display: 'flex',
                flexDirection: 'column',
                justifyContent: 'center',
                alignItems: 'center',
                minHeight: '100vh',
                margin: '0',
                backgroundColor: '#f0f0f0',
                fontFamily: 'Arial, sans-serif'
            });
        }
        
        function sendMessage(type, data = {}) {
            const message = {
                type: type,
                playerId: playerId,
                playerName: playerName,
                isHost: isHost,
                gameData: gameData,
                data: data
            };
            
            console.log(`Sending: ${type}`, message);
            
            connections.forEach(connection => {
                if (connection.open) {
                    connection.send(message);
                }
            });
        }
        
        function receiveMessage(message) {
            console.log(`Received: ${message.type}`, message);
            
            // Message from HOST TO GUEST
            if (message.isHost && !isHost) {
                gameData = message.gameData;
                if(['updatePlayerStatus', 'moveToWaitRoom', 'gameStarted', 'nameInUse', 'gameAlreadyStarted', 'YallStillHere'].includes(message.type)){
                    // Login Message from host to guest
                    handleLoginHostMessage(message);
                }
                else{
                    // Message from host to guest
                    handleHostMessage(message);
                }
            } 
            // Message from GUEST TO HOST
            else if (!message.isHost && isHost) {
                if(['playerJoined', 'startGame', 'IAmHere'].includes(message.type)){
                    // Login Message from guest to host
                    handleLoginGuestMessage(message);
                }
                else{
                    // Message from guest to host
                    handleGuestMessage(message);
                }
            }
        }

        function createButton(text, color, clickHandler) {
            const button = document.createElement('button');
            button.textContent = text;
            button.addEventListener('click', clickHandler);
            
            Object.assign(button.style, {
                padding: '15px 30px',
                backgroundColor: color,
                color: 'white',
                border: 'none',
                borderRadius: '5px',
                cursor: 'pointer',
                margin: '5px',
                fontSize: '16px',
                fontWeight: 'bold',
                transition: 'transform 0.2s ease'
            });
            
            button.addEventListener('mouseenter', () => {
                button.style.transform = 'scale(1.05)';
            });
            
            button.addEventListener('mouseleave', () => {
                button.style.transform = 'scale(1)';
            });
            
            return button;
        }
        
        function fadeOut(element, duration) {
            let opacity = 1; // Initial opacity
            const interval = 50; // Interval time in ms
            const decrement = interval / duration;

            const fade = setInterval(() => {
                opacity -= decrement;
                if (opacity <= 0) {
                    clearInterval(fade);
                    element.style.display = "none"; // Hide the element
                }
                element.style.opacity = opacity;
            }, interval);
        }
        
        // ========================================
        // AFTER LOGIN WAIT VIEW
        // ========================================
        
        function createView_AfterLoginWait(moveTo = true) {
            if(!moveTo){
                if(currentView == VIEWS.AFTER_LOGIN_WAIT){
                    moveTo = true // ASKED TO UPDATE
                }
            }

            if(moveTo){
                clearBody();
                currentView = VIEWS.AFTER_LOGIN_WAIT;
                
                const container = document.createElement('div');
                Object.assign(container.style, {
                    textAlign: 'center',
                    padding: '30px',
                    backgroundColor: 'white',
                    borderRadius: '15px',
                    boxShadow: '0 6px 12px rgba(0, 0, 0, 0.1)',
                    minWidth: '400px',
                    marginBottom: '120px'
                });
                
                // Title
                const title = document.createElement('h2');
                if(isHost){
                    title.textContent = 'Waiting for Players...';
                }
                else{
                    title.textContent = 'Waiting Room';
                }
                Object.assign(title.style, {
                    color: '#333',
                    marginBottom: '20px',
                    fontSize: '24px'
                });
                
                // Instructions
                const instructions = document.createElement('p');
                Object.assign(instructions.style, {
                    color: '#666',
                    fontSize: '16px',
                    marginBottom: '30px',
                    lineHeight: '1.5'
                });

                const playerCount = gameData.playerList.length;
                const isVIP = gameData.playerList.some(p => p.id === playerId && p.isVIP);

                if(isHost){
                    instructions.textContent = `Players are joining the game (currently ${playerCount}). The first player (VIP) will be able to start the game for everyone.`;
                }
                else{

                    if (isVIP) {
                        instructions.textContent = `You are the VIP! Need 1 or more players to start (currently ${playerCount}). Click "Start Game" when ready.`;
                    } else {
                        instructions.textContent = `Waiting for VIP to start the game... (currently ${playerCount} players)`;
                    }
                }

                container.appendChild(title);
                container.appendChild(instructions);

                if(!isHost){
                    if(isVIP && playerCount >= 1) {
                        const startButton = createButton('🎮 Start Game', '#28a745', handleStartGameClick);
                        startButton.style.fontSize = '18px';
                        startButton.style.padding = '20px 40px';
                        container.appendChild(startButton);
                    }
                }

                document.body.appendChild(container);
            }
        }

        function handleStartGameClick() {
            sendMessage('startGame');
        }
        
        // ========================================
        // HOST VIEWS
        // ========================================

        function createView_HostGameMain(moveTo = true) {
            if(!moveTo){
                if(currentView == VIEWS.HOST_GAME_MAIN){
                    moveTo = true // ASKED TO UPDATE
                }
            }

            if(moveTo){
                clearBody();
                currentView = VIEWS.HOST_GAME_MAIN;
                
                const container = document.createElement('div');
                Object.assign(container.style, {
                    textAlign: 'center',
                    padding: '20px',
                    backgroundColor: 'white',
                    borderRadius: '10px',
                    boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
                    marginBottom: '120px' // Add margin to avoid overlap with bottom status
                });
                
                // Game square
                const square = document.createElement('div');
                square.textContent = `(HOST) Current Turn: ${gameData.currentTurnPlayerName}`;
                square.id = 'gameSquare';
                
                Object.assign(square.style, {
                    width: '200px',
                    height: '200px',
                    backgroundColor: gameData.squareColor,
                    margin: '0 auto 20px',
                    cursor: 'pointer',
                    border: '3px solid #333',
                    borderRadius: '8px',
                    transition: 'all 0.3s ease',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'white',
                    fontSize: '18px',
                    fontWeight: 'bold',
                    userSelect: 'none'
                });
                
                // Square hover effects
                square.addEventListener('mouseenter', () => {
                    square.style.transform = 'scale(1.05)';
                    square.style.boxShadow = '0 8px 16px rgba(0, 0, 0, 0.2)';
                });
                
                square.addEventListener('mouseleave', () => {
                    square.style.transform = 'scale(1)';
                    square.style.boxShadow = 'none';
                });
                
                square.addEventListener('click', handleSquareClick);
                
                container.appendChild(square);
                document.body.appendChild(container);
            }
        }
        
        // ========================================
        //  PLAYER VIEWS
        // ========================================

        function createView_GameMain(moveTo = true) {
            if(!moveTo){
                if(currentView == VIEWS.GAME_MAIN){
                    moveTo = true // ASKED TO UPDATE
                }
            }

            if(moveTo){
                // Elements not wanted to be destroyed - since this is a toggle element
                let toggleShowColorButton = document.getElementById('toggleShowColorButton');

                clearBody();
                currentView = VIEWS.GAME_MAIN;
                
                const container = document.createElement('div');
                Object.assign(container.style, {
                    textAlign: 'center',
                    padding: '20px',
                    backgroundColor: 'white',
                    borderRadius: '10px',
                    boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
                    marginBottom: '120px' // Add margin to avoid overlap with bottom status
                });

                const currentTurn = gameData.playerList.some(p => p.id === playerId && p.name == gameData.currentTurnPlayerName);
                
                // Game square
                const square = document.createElement('div');
                if(currentTurn){
                    square.textContent = 'Click me!';
                }
                else{
                    square.textContent += `Current Turn: ${gameData.currentTurnPlayerName}`;
                }
                square.id = 'gameSquare';
                
                Object.assign(square.style, {
                    width: '200px',
                    height: '200px',
                    backgroundColor: gameData.squareColor,
                    margin: '0 auto 20px',
                    cursor: 'pointer',
                    border: '3px solid #333',
                    borderRadius: '8px',
                    transition: 'all 0.3s ease',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'white',
                    fontSize: '18px',
                    fontWeight: 'bold',
                    userSelect: 'none'
                });
                
                // Square hover effects
                square.addEventListener('mouseenter', () => {
                    square.style.transform = 'scale(1.05)';
                    square.style.boxShadow = '0 8px 16px rgba(0, 0, 0, 0.2)';
                });
                
                square.addEventListener('mouseleave', () => {
                    square.style.transform = 'scale(1)';
                    square.style.boxShadow = 'none';
                });

                let createView_GameChooseColorButton = createButton('Choose Color', 'black', function (){createView_GameChooseColor(true); })

                
                if(currentTurn){
                    square.addEventListener('click', handleSquareClick); 
                }

                if(toggleShowColorButton){}
                else{
                    toggleShowColorButton = createButton('Click to Show Color', 'black', function (){
                            let toggleShowColorButton = document.getElementById('toggleShowColorButton');
                            if(toggleShowColorButton){
                                toggleShowColorButton.showing = !toggleShowColorButton.showing
                                if(toggleShowColorButton.showing){
                                    toggleShowColorButton.textContent = 'Click to Hide';
                                    toggleShowColorButton.style.backgroundColor = gameData.playerList.filter(p => p.id == playerId)[0].color;
                                }
                                else{
                                    toggleShowColorButton.textContent = 'Click to Show Color';
                                    toggleShowColorButton.style.backgroundColor = 'black';
                                }
                            }
                        })
                    toggleShowColorButton.id = 'toggleShowColorButton';
                    toggleShowColorButton.showing = false;
                }
                
                container.appendChild(square);
                container.appendChild(createView_GameChooseColorButton);
                container.appendChild(toggleShowColorButton);
                document.body.appendChild(container);
            }
        }

        function createView_GameChooseColor(moveTo = true) {
            if(!moveTo){
                if(currentView == VIEWS.GAME_MAIN){
                    moveTo = true // ASKED TO UPDATE
                }
            }

            if(moveTo){
                clearBody();
                currentView = VIEWS.GAME_CHOOSE_COLOR;
                
                const container = document.createElement('div');
                Object.assign(container.style, {
                    textAlign: 'center',
                    padding: '20px',
                    backgroundColor: 'white',
                    borderRadius: '10px',
                    boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
                    marginBottom: '120px' // Add margin to avoid overlap with bottom status
                });

                let createView_GameMainButton = createButton('Back To Main View', 'black', function () { createView_GameMain(true); });
                createView_GameMainButton.style.alignItems = 'center';
                container.appendChild(createView_GameMainButton);
                playerAvalableColors.forEach(avalableColor => {
                    let button = createButton('Change your color to '+avalableColor, avalableColor, function () {sendMessage('requestChangeMyColor', {'newColor': avalableColor})});
                    button.style.alignItems = 'center';
                    container.appendChild(button);
                });


                document.body.appendChild(container);
            }
        }
        
        // ========================================
        // GAME EVENT HANDLERS
        // ========================================

        function handleSquareClick() {
            if (isHost) {
                // // Host changes color directly
                // gameData.squareColor = gameData.squareColor === 'blue' ? 'red' : 'blue';
                // const gameSquareDiv = document.getElementById('gameSquare');
                // if(gameSquareDiv){
                //     gameSquareDiv.backgroundColor = gameData.squareColor
                // }
                // sendMessage('squareColorChanged');
            } else {
                const playerInfo = gameData.playerList.filter(p => p.id == playerId)[0];
                // Guest requests color change
                sendMessage('requestSquareColorChange', {'playerColor': playerInfo.color});
            }
        }
        
        // ========================================
        // GAME MESSAGES
        // ========================================

        function handleHostMessage(message) {            
            switch (message.type) {
                case 'playerColorChanged':
                    break;
                case 'squareColorChanged':
                    // If gameSquare exist change it.
                    createView_GameMain(false);
                    break;
            }
        }
        
        function handleGuestMessage(message) {
            switch (message.type) {
                case 'requestChangeMyColor':
                    console.log('Changed the color1')
                    if(!gameData.playerList.some(p => p.color === message.data.newColor)){
                        console.log('Changed the color2')
                        gameData.playerList.filter(p => p.id == message.playerId)[0].color = message.data.newColor;
                    }
                    sendMessage('playerColorChanged');
                    break;

                case 'requestSquareColorChange':
                    if(gameData.currentTurnPlayerName == message.playerName){
                        // If gameSquare exist in host view then change it
                        gameData.squareColor = message.data.playerColor;

                        // Set Next turn
                        let newTurnNumber = (gameData.playerList.filter(p => p.name == gameData.currentTurnPlayerName)[0].turnOrder+1) % gameData.playerList.length;
                        gameData.currentTurnPlayerName = gameData.playerList.filter(p => p.turnOrder == newTurnNumber)[0].name;
                        
                        createView_HostGameMain(false);
                        sendMessage('squareColorChanged');
                    }
                    break;
            }
        }
        
        // ========================================
        // INITIALIZATION
        // ========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            applyBodyStyles();
            createView_Login();
        });
    </script>
</body>
</html>